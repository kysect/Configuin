using Kysect.CommonLib.BaseTypes.Extensions;
using Kysect.CommonLib.Collections.Extensions;
using Kysect.Configuin.EditorConfig.DocumentModel;
using Kysect.Configuin.EditorConfig.DocumentModel.Nodes;
using Kysect.Configuin.RoslynModels;

namespace Kysect.Configuin.EditorConfig.Formatter;

public class EditorConfigFormatter
{
    public EditorConfigDocument Format(EditorConfigDocument value)
    {
        List<IEditorConfigPropertyNode> nodesForRemoving = new List<IEditorConfigPropertyNode>();
        IReadOnlyCollection<IEditorConfigPropertyNode> styleRuleNodesForMoving = SelectIdeNodes(value, RoslynRuleTypes.StyleRule).OrderBy(r => r.Key).ToList();
        IReadOnlyCollection<IEditorConfigPropertyNode> qualityRuleNodesForMoving = SelectIdeNodes(value, RoslynRuleTypes.QualityRule).OrderBy(r => r.Key).ToList();
        nodesForRemoving.AddRange(styleRuleNodesForMoving);
        nodesForRemoving.AddRange(qualityRuleNodesForMoving);

        if (nodesForRemoving.IsEmpty())
            return value;

        EditorConfigCategoryNode autoGeneratedSection = CreateAutoGeneratedCategory(styleRuleNodesForMoving, [new RoslynQualityRuleFormattedSection("CA", qualityRuleNodesForMoving)]);

        return value
            .RemoveNodes(nodesForRemoving)
            .AddChild(autoGeneratedSection);
    }

    public EditorConfigDocument FormatAccordingToRuleDefinitions(EditorConfigDocument document, RoslynRules rules, bool groupQualityRulesByCategory = false)
    {
        rules.ThrowIfNull();

        List<IEditorConfigPropertyNode> nodesForRemoving = new List<IEditorConfigPropertyNode>();

        List<IEditorConfigPropertyNode> propertyNodes = document
            .DescendantNodes()
            .OfType<IEditorConfigPropertyNode>()
            .ToList();

        List<IEditorConfigPropertyNode> selectedStyleRuleNodes = new List<IEditorConfigPropertyNode>();
        foreach (RoslynStyleRuleGroup roslynStyleRuleGroup in rules.StyleRuleGroups)
        {
            foreach (RoslynStyleRule roslynStyleRule in roslynStyleRuleGroup.Rules)
            {
                IEditorConfigPropertyNode? editorConfigPropertyNode = TryFindSeverityNode(propertyNodes, roslynStyleRule.RuleId);
                if (editorConfigPropertyNode is null)
                    continue;

                selectedStyleRuleNodes.Add(editorConfigPropertyNode);
            }

            foreach (RoslynStyleRuleOption roslynStyleRuleOption in roslynStyleRuleGroup.Options)
            {
                IEditorConfigPropertyNode? editorConfigPropertyNode = TryFindOptionNode(propertyNodes, roslynStyleRuleOption);
                if (editorConfigPropertyNode is null)
                    continue;

                selectedStyleRuleNodes.Add(editorConfigPropertyNode);
            }

            if (roslynStyleRuleGroup.Rules.Any(r => r.RuleId.Equals(RoslynNameRuleInfo.RuleId)))
            {
                foreach (IEditorConfigPropertyNode editorConfigPropertyNode in propertyNodes)
                {
                    if (editorConfigPropertyNode is not EditorConfigRuleCompositeOptionNode option)
                        continue;

                    if (RoslynNameRuleInfo.IsNameRuleOption(option.ToFullString()))
                        selectedStyleRuleNodes.Add(editorConfigPropertyNode);
                }
            }
        }

        List<RoslynQualityRuleFormattedSection> formattedSections = new List<RoslynQualityRuleFormattedSection>();
        if (groupQualityRulesByCategory)
        {
            foreach (IGrouping<string, RoslynQualityRule> categoryRules in rules.QualityRules.GroupBy(r => r.Category).OrderBy(c => c.Key))
            {
                List<IEditorConfigPropertyNode> selectedQualityRuleNodes = new List<IEditorConfigPropertyNode>();
                foreach (RoslynQualityRule qualityRule in categoryRules.OrderBy(r => r.RuleId))
                {
                    IEditorConfigPropertyNode? editorConfigPropertyNode = TryFindSeverityNode(propertyNodes, qualityRule.RuleId);
                    if (editorConfigPropertyNode is null)
                        continue;

                    selectedQualityRuleNodes.Add(editorConfigPropertyNode);
                }

                if (selectedQualityRuleNodes.Any())
                    formattedSections.Add(new RoslynQualityRuleFormattedSection($"CA {categoryRules.Key}", selectedQualityRuleNodes));
            }
        }
        else
        {
            List<IEditorConfigPropertyNode> selectedQualityRuleNodes = new List<IEditorConfigPropertyNode>();
            foreach (RoslynQualityRule qualityRule in rules.QualityRules)
            {
                IEditorConfigPropertyNode? editorConfigPropertyNode = TryFindSeverityNode(propertyNodes, qualityRule.RuleId);
                if (editorConfigPropertyNode is null)
                    continue;

                selectedQualityRuleNodes.Add(editorConfigPropertyNode);
            }
            if (selectedQualityRuleNodes.Any())
                formattedSections.Add(new RoslynQualityRuleFormattedSection("CA", selectedQualityRuleNodes));
        }

        nodesForRemoving.AddRange(selectedStyleRuleNodes);
        nodesForRemoving.AddRange(formattedSections.SelectMany(s => s.SelectedQualityRuleNodes));
        EditorConfigCategoryNode autoGeneratedSection = CreateAutoGeneratedCategory(selectedStyleRuleNodes, formattedSections);

        return document
            .RemoveNodes(nodesForRemoving)
            .AddChild(autoGeneratedSection);
    }

    public record RoslynQualityRuleFormattedSection(string Title, IReadOnlyCollection<IEditorConfigPropertyNode> SelectedQualityRuleNodes);

    private EditorConfigCategoryNode CreateAutoGeneratedCategory(
        IReadOnlyCollection<IEditorConfigPropertyNode> styleRuleNodesForMoving,
        IReadOnlyCollection<RoslynQualityRuleFormattedSection> qualityRuleNodesForMoving)
    {
        var autoGeneratedSection = new EditorConfigCategoryNode("*.cs", [], ["# Autogenerated values"], null);

        if (styleRuleNodesForMoving.Any())
        {
            var styleRuleSection = new EditorConfigDocumentSectionNode("### IDE ###");

            foreach (IEditorConfigPropertyNode styleRule in styleRuleNodesForMoving)
                styleRuleSection = styleRuleSection.AddChild(styleRule);

            autoGeneratedSection = autoGeneratedSection.AddChild(styleRuleSection);
        }

        foreach (RoslynQualityRuleFormattedSection roslynQualityRuleFormattedSection in qualityRuleNodesForMoving)
        {
            if (roslynQualityRuleFormattedSection.SelectedQualityRuleNodes.IsEmpty())
                continue;

            var qualitySection = new EditorConfigDocumentSectionNode($"### {roslynQualityRuleFormattedSection.Title} ###");
            foreach (IEditorConfigPropertyNode qualityRule in roslynQualityRuleFormattedSection.SelectedQualityRuleNodes)
                qualitySection = qualitySection.AddChild(qualityRule);
            autoGeneratedSection = autoGeneratedSection.AddChild(qualitySection);
        }

        return autoGeneratedSection;
    }

    private IReadOnlyCollection<IEditorConfigPropertyNode> SelectIdeNodes(EditorConfigDocument document, string ruleType)
    {
        List<IEditorConfigPropertyNode> propertyNodes = document
            .DescendantNodes()
            .OfType<IEditorConfigPropertyNode>()
            .ToList();

        List<IEditorConfigPropertyNode> styleRuleNodes = new List<IEditorConfigPropertyNode>();
        foreach (IEditorConfigPropertyNode editorConfigPropertyNode in propertyNodes)
        {
            if (editorConfigPropertyNode is not EditorConfigRuleSeverityNode severityConfigSetting)
                continue;

            if (severityConfigSetting.RuleId.RuleType == ruleType)
                styleRuleNodes.Add(editorConfigPropertyNode);
        }

        return styleRuleNodes;
    }

    private IEditorConfigPropertyNode? TryFindSeverityNode(IReadOnlyCollection<IEditorConfigPropertyNode> propertyNodes, RoslynRuleId id)
    {
        foreach (IEditorConfigPropertyNode editorConfigPropertyNode in propertyNodes)
        {
            if (editorConfigPropertyNode is not EditorConfigRuleSeverityNode severitySettings)
                continue;

            if (severitySettings.RuleId == id)
                return editorConfigPropertyNode;
        }

        return null;
    }

    private IEditorConfigPropertyNode? TryFindOptionNode(IReadOnlyCollection<IEditorConfigPropertyNode> propertyNodes, RoslynStyleRuleOption roslynStyleRuleOption)
    {
        foreach (IEditorConfigPropertyNode editorConfigPropertyNode in propertyNodes)
        {
            if (editorConfigPropertyNode is not EditorConfigRuleOptionNode option)
                continue;

            if (option.Key == roslynStyleRuleOption.Name)
                return editorConfigPropertyNode;
        }

        return null;
    }
}